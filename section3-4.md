## 3.4. 指令集



### 3.4.1. 概要


PIO 指令为 16 位，编码方式如下：

![表376](figures/table-376.png)

所有 PIO 指令的执行时间都是一个时钟周期。

5 比特的 `Delay/side-set` 字段的含义依赖于状态机的 `SIDESET_COUNT` 配置：

- 最多 5 个 LSB 比特（5 减 `SIDESET_COUNT`）为当前指令和下一条指令之间插入的空闲周期数。
- 最多 5 个 MSB 比特（由 `SIDESET_COUNT` 设置）为 side-set（参见[3.5.1节](#351-TODO)），可以在该指令执行的同时，将某些 GPIO 管脚设置为某个常量。


### 3.4.2. JMP

#### 3.4.2.1. 编码

![JMP](figures/instruction-jmp.png)


#### 3.4.2.2. 操作

如果 `Condition` 为真，则将程序计数器设置为 `Address`，否则无操作。

`JMP` 上的延时周期不论 `Condition` 是否为真都会生效。延时在 `Condition` 被求值、程序计数器被更新后进行。

- Condition：
  - 000：（无条件）：永远跳转
  - 001：`!X`：当寄存器 X 为零时
  - 010：`X--`：当 X 非零时。判断后进行减一
  - 011：`!Y`：当寄存器 Y 为零时
  - 100：`Y--`：当 Y 非零时。判断后进行减一
  - 101：`X!=Y`：当 X 不等于 Y 时
  - 110：`PIN`：根据输入管脚跳转
  - 111：`!OSRE`：当输出移位寄存器非空时
- Address：要跳转到的指令地址。在指令编码中，该值为 PIO 指令内存中的绝对地址。

`JMP PIN` 会根据 `EXECCTRL_JMP_PIN` 选择的 GPIO 管脚进行跳转。`EXECCTRL_JMP_PIN` 是一个可配置选项，它从状态机可以使用的最多 32 个 GPIO 输入管脚中选择其中之一，供 JMP 使用。不依赖于状态机的其他输入映射。
如果该 GPIO 为高电平，则跳转。

`!OSRE` 将自上一次 `PULL` 以来移出的比特数，与移位计数阈值进行比较。移位计数阈值由 `SHIFTCTRL_PULL_THRESH` 配置。自动加载（autopull，参见[3.5.4节](section3-5#354-TODO)）也通过该配置项配置。


`JMP X--` 和 `JMP Y--` 总是会将寄存器 X 或 Y 减一。减一操作与可擦写寄存器的当前值无关。跳转条件是寄存器的*初始值*，即减一操作发生之前的值。如果寄存器最初为非零值，则发生跳转。



#### 3.4.2.3. 汇编语法

`jmp (<cond>) <target>`

其中：

`<cond>` 是上节列出的可选的条件（例如，`!x` 表示可擦写寄存器 X 为零）。如果未指定条件，则总是跳转。

`<target>` 是一个程序标签或值（参见[3.3.2节](#332-值))，表示程序内部的指令偏移量（第一条指令的偏移量为 0）。注意，由于 PIO JMP 指令使用 PIO 指令内存之内的绝对地址，JMP 需要在运行时根据程序的加载偏移量进行调整。
这一步在加载程序时由 SDK 负责，但在编码 JMP 指令供 `OUT EXEC` 使用时需要留意这一点。


### 3.4.3. WAIT

#### 3.4.3.1. 编码

![WAIT](figures/instruction-wait.png)


#### 3.4.3.2. 操作

等待，直到条件满足。

与所有等待指令一样（参见[3.2.4节](section3-2)），延时周期在指令*完成*之后发生。也就是说，如果指定了延时周期，那么延时要直到等待条件满足*之后*才会开始。

- Polarity
  - 1：等待 1。
  - 0：等待 0。
- Source：指定要等待什么。可能的值有：
  - 00:`GPIO`：等待由 `Index` 选择的系统 GPIO 输入。该项为绝对 GPIO 索引，不受状态机的输入 IO 映射影响。
  - 01：`PIN`：由 `Index` 指定的输入管脚。首先会应用当前状态机的输入 IO 映射，然后利用 `Index` 选择要等待哪个输入比特。换句话说，选择的管脚就是 `PINCTRL_IN_BASE` 加上 `Index`，再对 32 取余。
  - 10：`IRQ`：等待由 `Index` 选择的 PIO IRQ 标志。
  - 11：保留
- Index：要检查哪个管脚或比特。

`WAIT x IRQ` 的行为与其他 `WAIT` 源略有不同：

- 如果 `Polarity` 为 1，则在等待条件满足后，当前状态机会清除选择的 IRQ 标志。
- 标志位索引的解码方式与 `IRQ` 的索引字段相同：如果 MSB 被设置，则将状态机的 ID（0..3）加到 IRQ 索引上，加法采用两个 LSB 的模 4 加法。例如，状态机 2、标志值为 '0x11'，则等待标志 3，而标志值 '0x13' 将等待标志 1。这样，运行同一个程序的多个状态机就可以互相同步。

**注意** `WAIT 1 IRQ x` 不应当使用供中断控制器使用的 IRQ 标志，以避免与系统中断处理函数的竞合冲突。


#### 3.4.3.3. 汇编语法

`wait <polarity> gpio <gpio_num>`

`wait <polarity> pin <pin_num>`

`wait <polarity> irq <irq_num> ( rel )`

其中：

`<polarity>` 是一个值（参见[3.3.2节](#332-值)），指定极性（0 或 1）

`<pin_num>` 是一个值（参见[3.3.2节](#332-值)），指定输入管脚的编号（在状态机输入管教映射中的编号）

`<gpio_num>` 是一个值（参见[3.3.2节](#332-值)），指定实际的 GPIO 管脚编号

`<irq_num> ( rel )` 是一个值（参见[3.3.2节](#332-值)），指定要等待的 IRQ 编号（0 ~ 7）。如果设置了 `rel`，则实际的 IRQ 编号的计算方式为，将 IRQ 编号的最低两个比特（`irq_num`_10）替换成和的最低两个比特（`irq_num`_10 + `sm_num`_10），其中 `sm_num`_10 为状态机编号


### 3.4.4. IN


#### 3.4.4.1. 编码




